---
title: ItsyBitsy Write-up (TryHackMe)
date: 2023-12-06 17:13:00 -0500
categories: [Write-ups, TryHackMe]
tags: [incident response, siem, elasticstack, log analysis, url2png, c2] # TAG names should always be lowercase
---

## Overview

In this TryHackMe room we will be an investigating an alert generated by an IDS regarding potential C2 communication.
We will be utilizing [Elastic Stack (ELK)](https://www.elastic.co/elastic-stack), a group of open source products used in combination as a Security Information and Event Management system (SIEM) in many organizations.

![c2-hacking-hero-1](/assets/img/c2-hacking-hero-1.png)

### Scenario

During normal SOC monitoring, Analyst **John** observed an alert on an IDS solution indicating a potential C2 communication from a user **Browne** from the HR department.
A suspicious file was accessed containing a malicious pattern `THM:{ ________ }`.
A week-long HTTP connection logs have been pulled to investigate.
Due to limited resources, only the connection logs could be pulled out and are ingested into the *connection_logs* index in Kibana.

Our task in this room will be to examine the network connection logs of this user, find the link and the content of the file, and answer the questions.

***

## Solution

Before continuing, we must deploy the machine on TryHackMe by clicking **Start Machine**. After a few minutes, the machine ip will appear and we can access the webgui by entering `http://<MACHINE_IP>` in a browser and using the following credentials to login:

Username: `Admin`

Password: `elastic123`

> In order to access the machine you must connect through [VPN](https://tryhackme.com/access) or through TryHackMe's Attackbox.
{: .prompt-warning }

### Q1. How many events were returned for the month of March 2022?

To perform queries on the log files, we need to first navigate to the discover page from the menu.

![elastic-discover](/assets/img/elastic-discover.png)
_Navigating to Discover page on Elastic_

Now we can filter the date range on the right-hand side of the page and select the starting date as `March 1, 2022 @ 00:00:00.000` and the ending date as `March 31, 2022 @ 23:59:00.000`. This will return all events logged within March of 2022.

![elastic-date-range-filter](/assets/img/elastic-date-range-filter.png)
![elastic-date-filter-results](/assets/img/elastic-date-filter-results.png)
_Search results of logs from March 2022_

***Answer: 1482***

### Q2. What is the IP associated with the suspected user in the logs?

Since looking for C2 communication, we can try to look for outbound HTTP connections with non-standard ports. HTTP traffic uses port 80 and HTTPS uses port 443 so if we find any other port numbers, this could be an indication of malicious traffic.
Unfortunately, when clicking on the `destination_port` field in the right hand pane, we see that all traffic has a destination port of 80.

![elastic-destination-port](/assets/img/elastic-destination-port.png)
_Results for destination ports_

Another approach is to filter the traffic based on source ip address. Clicking on the `source_ip` field in the left-hand pane gives us 2 results, *192.166.65.52* and *192.166.65.54*. Since the second source ip address has a mere 0.4% of the traffic, we can query for any logs that have this source ip by using the following query:

`source_ip : 192.166.65.54`

![elastic-source-ip-filter](/assets/img/elastic-source-ip-filter.png)
_Search results for logs with source ip of 192.166.65.54_

***Answer: 192.166.65.54***

### Q3. The user's machine used a legit windows binary to download a file from the C2 server. What is the name of the binary?

The results of the query from the previous question shows us 2 logs. Reading through the second log, we see a particular user agent being used that is not a typical browser.

![elastic-user-agent](/assets/img/elastic-user-agent.png)
_Log details containing unusual user agent_

> Bitsadmin is a command-line tool used to download or upload files on Windows machines.
{: .prompt-info }

***Answer: bitsadmin***

### Q4. The infected machine connected with a famous filesharing site in this period, which also acts as a C2 server used by the malware authors to communicate. What is the name of the filesharing site?

Looking at the log from the previous question, if we take a look at the `host` field we can see the site used by the C2 server.

![elastic-c2-site](/assets/img/elastic-c2-site.png)
_Log details containing the site used by the C2 server_

***Answer: pastebin.com***

### Q5. What is the full URL of the C2 to which the infected host is connected?

We know from the previous question that the site being used by the C2 server is `pastebin.com`.
We can look at the `uri` field in the log details to find the URI and append it to the host to get the URL.

![elastic-uri](/assets/img/elastic-uri.png)
_Log details containing the URI_

***Answer: pastebin.com/yTg0Ah6a***

### Q6. A file was accessed on the filesharing site. What is the name of the file accessed?

In order to view the content on the filesharing site, we can utilize a tool called [URL2PNG](https://www.url2png.com/). 
This tool is very useful for viewing websites that could potentially be malicious without the risk of infecting your machine.

![elastic-file-name](/assets/img/elastic-file-name.png)
_URL2PNG results of the file sharing site_

***Answer: secret.txt***

### Q7. The file contains a secret code with the format THM{_____}.

We can find the secret code from the results of the previous question.

***Answer: THM{SECRET__CODE}***